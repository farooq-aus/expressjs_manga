{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Buffer } from 'buffer';\nimport crypto from 'crypto';\nimport delay from 'delay';\nimport got, { Response, RetryOptions } from 'got';\nimport https from 'https';\nimport uaString from 'ua-string';\nimport vm from 'vm';\nimport { URLSearchParams } from 'url';\n\nconst BUG_REPORT = `\\\nCloudflare may have changed their technique, or there may be a bug in the script.\nPlease read https://github.com/typectrl/cloudflare#updates, then file a \\\nbug report at https://github.com/typectrl/cloudflare/issues\"\\\n`;\n\nexport function isCloudflareChallenge(statusCode: number, headers: any, body: string) {\n  const { server } = headers;\n  return (\n    statusCode === 503 &&\n    server.startsWith('cloudflare') &&\n    body.includes('jschl_vc') &&\n    body.includes('jschl_answer')\n  );\n}\n\nexport function isCloudflareCaptcha(body: string) {\n  if (body.includes('why_captcha') || /cdn-cgi\\/l\\/chk_captcha/i.test(body)) {\n    return true;\n  }\n\n  return false;\n}\n\nexport function solveChallenge(body: string, domain: string) {\n  // regex without selecting setTimeout delay ms for reference\n  // const timeoutReg = /setTimeout\\(function\\(\\){\\s+(var s,t,o,p,b,r,e,a,k,i,n,g,f.+?\\r?\\n[\\s\\S]+?a\\.value =.+?)\\r?\\n/;\n  const timeoutReg = /setTimeout\\(function\\(\\){\\s+(var s,t,o,p,b,r,e,a,k,i,n,g,f.+?\\r?\\n[\\s\\S]+?a\\.value =.+?)\\r?\\n[\\s\\S]+(\\d{4,5})\\);/;\n  const timeout = timeoutReg.exec(body);\n  let js = timeout && timeout.length ? timeout[1] : '';\n  js = js.replace(/a\\.value = (.+\\.toFixed\\(10\\);).+\", r\"\\1/i, '$1');\n  js = js.replace(/(e\\s=\\sfunction\\(s\\)\\s{[\\s\\S]*};)/g, '');\n  js = js.replace(/\\s{3,}[a-z](?: = |\\.).+/g, '');\n  js = js.replace(/'; \\d+'/g, '');\n  // Strip characters that could be used to exit the string context\n  // These characters are not currently used in Cloudflare's arithmetic snippet\n  js = js.replace(/[\\n\\\\']/, '');\n  js = js.replace('; 121', '');\n\n  if (!js.includes('toFixed')) {\n    throw new Error(`Error parsing Cloudflare IUAM Javascript challenge. ${BUG_REPORT}`);\n  }\n\n  // get setTimeout length that cloudflare has mandated\n  const ms = timeout && timeout.length > 1 ? Number(timeout[2]) : 6000;\n\n  // 2019-03-20: Cloudflare sometimes stores part of the challenge in a div which is later\n  // added using document.getElementById(x).innerHTML, so it is necessary to simulate that\n  // method and value.\n  let k = '';\n  let val = '';\n  const kReg = /k\\s+=\\s+'([^']+)';/g;\n  try {\n    // Find the id of the div in the javascript code.\n    const kResult = kReg.exec(body);\n    k = kResult && kResult.length ? kResult[1] : '';\n    const valReg = new RegExp(`<div(.*)id=\"${k}\"(.*)>(.*)</div>`, 'g');\n    const valResult = valReg.exec(body);\n    val = valResult && valResult.length ? valResult[3] : '';\n  } catch {\n    // If not available, either the code has been modified again, or the old style challenge is used.\n    // ignore errors\n  }\n\n  const dom = `var t = \"${domain}\";`;\n  const a = 'var a = {};';\n  const o = 'var o = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";';\n  const e = `var e = function(s) {{\n      s += \"==\".slice(2 - (s.length & 3));\n      var bm, r = \"\", r1, r2, i = 0;\n      for (; i < s.length;) {{\n          bm = o.indexOf(s.charAt(i++)) << 18 | o.indexOf(s.charAt(i++)) << 12 | (r1 = o.indexOf(s.charAt(i++))) << 6 | (r2 = o.indexOf(s.charAt(i++)));\n          r += r1 === 64 ? g(bm >> 16 & 255) : r2 === 64 ? g(bm >> 16 & 255, bm >> 8 & 255) : g(bm >> 16 & 255, bm >> 8 & 255, bm & 255);\n      }}\n      return r;\n  }};`;\n  const g = 'var g = String.fromCharCode;';\n  const document = `var document= {getElementById: function(x) { return {innerHTML:\"${val}\"};}};`;\n  const atob = 'var atob = function(str) {return Buffer.from(str, \"base64\").toString(\"binary\");};';\n  const jsx = a + o + e + dom + atob + g + document + js;\n  const str = vm.runInNewContext(jsx, { Buffer, g: String.fromCharCode }, { timeout: 5000 });\n  // must eval javascript - potentially very unsafe\n  // eslint-disable-next-line no-eval\n  const answer = Number(str);\n\n  try {\n    return { ms, answer };\n  } catch (err) {\n    throw new Error(`Error occurred during evaluation: ${err.message}`);\n  }\n}\n\nexport function jschlValue(body: string) {\n  const vcReg = /name=\"jschl_vc\"\\svalue=\"(\\w+)\"/g;\n  const vc = vcReg.exec(body);\n  return vc && vc.length ? vc[1] : '';\n}\n\nexport function passValue(body: string) {\n  const passReg = /name=\"pass\"\\svalue=\"(.+?)\"/g;\n  const p = passReg.exec(body);\n  return p && p.length ? p[1] : '';\n}\n\nexport function sValue(body: string) {\n  const sReg = /name=\"s\"\\svalue=\"([^\"]+)/g;\n  const s = sReg.exec(body);\n  return s && s.length ? s[1] : '';\n}\n\nexport function getRValue(body: string): object {\n  // eslint-disable-next-line @typescript-eslint/prefer-regexp-exec\n  const match = body.match(/name=\"(.+?)\" value=\"(.+?)\"/);\n  if (match) {\n    const hiddenInputName = match[1];\n    return { [hiddenInputName]: match[2] };\n  }\n\n  return {};\n}\n\nexport function getMethod(body: string) {\n  const methodReg = /method=\"(.+?)\"/g;\n  const s = methodReg.exec(body);\n  return s && s.length ? s[1] : 'GET';\n}\n\n/**\n * sets headers.accept and headers.user-agent if not exist\n * @param headers existing headers\n */\nexport function setupHeaders(headers: any = {}): any {\n  headers.accept =\n    headers.accept ||\n    'application/xml,application/xhtml+xml,text/html;q=0.9, text/plain;q=0.8,image/png,*/*;q=0.5';\n  headers['user-agent'] = headers['user-agent'] || uaString;\n  return headers;\n}\n\nclass CaptchaError extends Error {\n  constructor(message?: string) {\n    super(message); // 'Error' breaks prototype chain here\n    Object.setPrototypeOf(this, new.target.prototype); // restore prototype chain\n  }\n}\n\nclass CloudflareMaxAttemptsError extends Error {\n  constructor(message?: string) {\n    super(message); // 'Error' breaks prototype chain here\n    Object.setPrototypeOf(this, new.target.prototype); // restore prototype chain\n  }\n}\n\nexport async function catchCloudflare<T extends Buffer | string | object>(\n  error: any,\n  options: any,\n  attempts = 1,\n): Promise<Response<T>> {\n  const config: any = { ...options };\n  // must have body present\n  if (!error.response || !error.response.body) {\n    throw error;\n  }\n\n  // must have cookiejar\n  if (!config.cookieJar) {\n    throw new Error('options.cookieJar required');\n  }\n\n  const { body } = error.response;\n\n  // recaptcha captcha encountered\n  if (isCloudflareCaptcha(body)) {\n    throw new CaptchaError('Cloudflare captcha encountered');\n  }\n\n  // error is not cloudflare related - rethrow\n  if (!isCloudflareChallenge(error.response.statusCode, error.response.headers, body)) {\n    throw error;\n  }\n\n  // max attempt error\n  if (attempts === 4) {\n    throw new CloudflareMaxAttemptsError(`Unable to bypass cloudflare attempts: ${attempts}`);\n  }\n\n  config.headers = config.headers || {};\n  config.headers = setupHeaders(config.headers);\n  config.headers.referer = `${error.url.substring(0, error.url.length - 1)}${error.path || ''}`;\n  config.headers['cache-control'] = config.headers['cache-control'] || 'private';\n  const retry: RetryOptions = config.retry || {};\n  config.retry.statusCodes = [408, 413, 429, 500, 502, 504];\n  config.retry = retry;\n\n  // get form field values\n  const jschlVc = jschlValue(body);\n  const pass = passValue(body);\n  const s = sValue(body);\n  const rValue = getRValue(body);\n  const method = getMethod(body);\n  // solve js challenge\n  const challenge = solveChallenge(body, error.hostname);\n\n  // defaults to 6 seconds or ms found in html\n  await delay(challenge.ms);\n\n  // make request with answer\n  const submitUrl = `${error.protocol}//${error.hostname}`;\n  const payload: any = {\n    ...rValue,\n    // eslint-disable-next-line @typescript-eslint/camelcase\n    jschl_vc: jschlVc,\n    pass,\n    // eslint-disable-next-line @typescript-eslint/camelcase\n    jschl_answer: challenge.answer,\n  };\n\n  if (method.toUpperCase() === 'GET') {\n    config.method = 'GET';\n    config.path = '/cdn-cgi/l/chk_jschl';\n    payload.s = s;\n    config.query = payload;\n  } else {\n    config.method = 'POST';\n    const queryMatch = body.match(/id=\"challenge-form\" action=\"(.+?)\" method=\"(.+?)\"/);\n    config.query = queryMatch[1];\n    const params = new URLSearchParams();\n    for (const entry of Object.entries(payload)) {\n      params.append(entry[0], entry[1] as string);\n    }\n\n    config.body = params.toString();\n    config.headers = {\n      ...config.headers,\n      'content-type': 'application/x-www-form-urlencoded',\n    };\n    config.followRedirect = true;\n  }\n\n  if (!config.agent) {\n    config.agent = {\n      https: new https.Agent({\n        ciphers: crypto.constants.defaultCipherList + ':!ECDHE+SHA:!AES128-SHA',\n      }),\n    };\n  }\n\n  try {\n    return await got(submitUrl, config);\n  } catch (err) {\n    // eslint-disable-next-line no-return-await\n    return await catchCloudflare(err, config, attempts + 1);\n  }\n}\n"]}